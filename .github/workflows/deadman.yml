name: Deadman Switch - System Health Check

on:
  schedule:
    - cron: "*/30 * * * *" # Every 30 minutes
  workflow_dispatch: # Allow manual triggering

jobs:
  check-heartbeat:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check system heartbeat
        id: heartbeat
        run: |
          python - <<'EOF'
          import json, os, sys
          from datetime import datetime, timezone, timedelta

          HEARTBEAT_FILE = "ops/heartbeat.json"
          MAX_MINUTES = int(os.getenv("HEARTBEAT_MAX_MINUTES", "60"))

          try:
              with open(HEARTBEAT_FILE) as f:
                  heartbeat = json.load(f)
              last_ok = datetime.fromisoformat(heartbeat["last_ok"])
          except FileNotFoundError:
              print(f"âŒ HEARTBEAT FILE MISSING: {HEARTBEAT_FILE}")
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("status=missing_file\n")
              sys.exit(1)
          except Exception as e:
              print(f"âŒ HEARTBEAT FILE CORRUPT: {e}")
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("status=corrupt_file\n")
              sys.exit(1)

          # Calculate age
          now = datetime.now(timezone.utc)
          age = now - last_ok.astimezone(timezone.utc)
          age_minutes = age.total_seconds() / 60

          print(f"ðŸ“Š Heartbeat age: {age_minutes:.1f} minutes")
          print(f"ðŸ“… Last OK: {last_ok}")
          print(f"ðŸŽ¯ Threshold: {MAX_MINUTES} minutes")

          if age > timedelta(minutes=MAX_MINUTES):
              print(f"ðŸš¨ STALE HEARTBEAT: {age_minutes:.1f} minutes old (threshold: {MAX_MINUTES})")
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write(f"status=stale\n")
                  f.write(f"age={age_minutes:.1f}\n")
              sys.exit(1)
          else:
              print(f"âœ… Heartbeat OK: {age_minutes:.1f} minutes old")
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("status=ok\n")
                  f.write(f"age={age_minutes:.1f}\n")
          EOF

      - name: Alert on heartbeat failure
        if: failure()
        run: |
          echo "ðŸš¨ CRITICAL: System heartbeat check failed!"
          echo "This indicates the image workflow system may not be running properly."

          # Create a GitHub issue for tracking
          echo "HEARTBEAT_STATUS=failure" >> $GITHUB_ENV
          echo "ISSUE_TITLE=ðŸš¨ System Heartbeat Failure - $(date)" >> $GITHUB_ENV

          # You can add webhook notifications here
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"ðŸš¨ Image workflow heartbeat failed!"}' \
          #   $SLACK_WEBHOOK_URL

      - name: Report healthy status
        if: success()
        run: |
          echo "âœ… System heartbeat is healthy"
          echo "All monitoring systems are functioning normally."
