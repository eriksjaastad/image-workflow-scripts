# Project - Cursor AI Rules

# ========================

## üìö Related Documentation

**Before writing code, review these rules:**

- **File Safety:** See this file below (Critical File Safety Rules)
- **Code Quality:** `Documents/reference/CODE_QUALITY_RULES.md` (Ruff/linting standards)
- **Raptor Review:** `prompts/README.md` (3-phase reliability review process)
- **Global Cursor Rules:** `cursor_global_rules_kit.md` (session management, execution rules)

---

## üîç CODE QUALITY & LINTING RULES

**These rules are enforced by Ruff and pre-commit hooks. All AI code must follow them.**

### **1. Never Use Silent Broad Exceptions**

‚ùå **FORBIDDEN:**

```python
try:
    risky_operation()
except:  # Bare except - catches everything
    pass

try:
    risky_operation()
except Exception:  # Silent exception - hides bugs
    pass
```

‚úÖ **REQUIRED:**

```python
try:
    risky_operation()
except FileNotFoundError as e:
    logger.error(f"File not found: {e}")
    raise

try:
    risky_operation()
except SpecificException as e:
    logger.error(f"Error: {e}")
    raise  # Re-raise after logging
```

**Why:** Silent failures hide bugs. Always log the error and re-raise or handle with a specific exception.

### **2. Prints in Library Code vs CLI Scripts**

‚ùå **FORBIDDEN in library code:**

```python
# scripts/utils/helper.py - NO PRINTS!
def process_data(data):
    print("Processing...")  # Use logging instead
    return data
```

‚úÖ **ALLOWED in CLI scripts only:**

```python
# scripts/00_start_project.py - Prints OK here!
print("Starting project...")

# scripts/utils/helper.py - Use logging!
import logging
logger = logging.getLogger(__name__)
logger.info("Processing data...")
```

**Exempted files (prints allowed):**

- `scripts/[0-9][0-9]_*.py` (numbered workflow scripts like `00_start_project.py`)
- `scripts/tools/**` (CLI tools)
- `scripts/**/run_*.py` (run scripts)
- `scripts/dashboard/**` (dashboard outputs)
- `scripts/**/test_*.py` (tests)

**All other files:** Use `logging` instead of `print()`

### **3. Timezone-Aware Datetimes**

‚ùå **DANGEROUS - timezone-naive:**

```python
from datetime import datetime
now = datetime.now()  # Which timezone?
```

‚úÖ **SAFE - timezone-aware:**

```python
from datetime import datetime, timezone
now = datetime.now(timezone.utc)  # Explicit UTC

# Or with UTC constant (Python 3.11+)
from datetime import UTC, datetime
now = datetime.now(UTC)
```

### **4. Separate Error Message Construction**

‚ùå **BAD - f-string in exception:**

```python
raise ValueError(f"Invalid value: {value}")
```

‚úÖ **GOOD - separate message construction:**

```python
msg = f"Invalid value: {value}"
raise ValueError(msg)
```

**Why:** Makes error messages easier to test and maintain.

### **5. Remove Unused Imports**

‚ùå **FORBIDDEN:**

```python
import os
import sys  # Never used
import unused_module
```

‚úÖ **REQUIRED:**

```python
import os  # Only import what you use
```

### **6. No Debugger Statements**

‚ùå **FORBIDDEN:**

```python
import pdb; pdb.set_trace()  # Remove before committing
breakpoint()  # Remove before committing
```

### **Quick Reference for Code Generation**

Before writing code, ask yourself:

1. **Is this library code or a CLI script?** ‚Üí Determines print vs logging
2. **Am I catching exceptions?** ‚Üí Log + re-raise or catch specific exceptions
3. **Am I using datetime?** ‚Üí Must use `timezone.utc`
4. **Did I import everything I'm using?** ‚Üí Remove unused imports
5. **Are error messages constructed separately?** ‚Üí For testability

---

## üö® CRITICAL FILE SAFETY RULES - NEVER VIOLATE

### **Rule #1: NO FILE CONTENT MODIFICATIONS**

- NEVER modify image files (PNG, JPG, JPEG, etc.) in-place
- NEVER modify companion files (YAML, caption, txt, etc.) in-place
- The ONLY exception: `04_desktop_multi_crop.py` may write cropped PNG files
- All other scripts are READ-ONLY for file contents

### **Rule #2: File Operations Allowed**

‚úÖ **SAFE Operations:**

- Moving files (with companions): `move_file_with_all_companions()`
- Deleting files (to Trash): `send2trash()` or `mv ~/.Trash/`
- Reading files: `open(file, 'r')`, `Path.read_text()`
- Creating NEW files: logs, reports, thumbnails in designated directories
- Copying files: `shutil.copy()` to NEW locations only

‚ùå **FORBIDDEN Operations:**

- `open(file, 'w')` on existing PNG/YAML/caption files (except crop tool)
- `open(file, 'wb')` on existing images (except crop tool)
- `PIL.Image.save()` overwriting existing files (except crop tool)
- In-place modifications of any production image/companion files
- `shutil.move()` with overwrite on existing files

### **Rule #3: Designated Safe Zones**

**Where NEW files CAN be created:**

- `data/ai_data/` - AI training data, embeddings, caches
- `data/file_operations_logs/` - Operation logs
- `data/daily_summaries/` - Report files
- `sandbox/` - Testing and experiments
- `__delete_staging/` - Orphaned files awaiting manual review before deletion
- Temporary directories created by scripts

**Where files CANNOT be modified:**

- `mojo1/`, `mojo2/` - Production image directories
- `selected/` - Selected images awaiting processing
- `crop/` - Cropped images (except by crop tool creating them)
- Any directory containing production images

### **Rule #4: Move, Don't Modify**

- Philosophy: We MOVE files between directories, we DON'T change their contents
- If you need to "update" a file, create a NEW version with different name
- Exception: Crop tool creates NEW cropped versions (technically a new file)

### **Rule #5: Companion File Integrity**

- When moving/copying/deleting images, ALWAYS handle ALL companion files together
- Use `find_all_companion_files()` and `move_file_with_all_companions()`
- NEVER orphan companion files
- NEVER move image without its YAML/caption

### **Rule #6: Code Review Checklist**

Before writing ANY file operation code, verify:

1. ‚úÖ Is this a move/delete operation? (Safe)
2. ‚úÖ Is this creating a NEW file in a safe zone? (Safe)
3. ‚úÖ Is this the crop tool writing a cropped image? (Safe)
4. ‚ùå Is this modifying an existing production file? (FORBIDDEN)

### **Rule #7: Logging Requirements**

- ALL file operations MUST log via FileTracker
- Format: `tracker.track_file_operation(operation, source, dest)`
- Operations: 'move', 'delete', 'crop', 'copy', 'create'
- This creates an audit trail for safety verification

### **Rule #8: Single TODO List Policy**

- Maintain ONE authoritative TODO document: `Documents/core/CURRENT_TODO_LIST.md`
- Do NOT create separate TODO lists elsewhere (no duplicates in Documents/, scripts/, etc.)
- If a sub-area needs grouping, add a section/header inside the single TODO doc (e.g., "AI Automation")
- When consolidating, move remaining items into the single doc and delete the extra file

## üìã Quick Reference

**Safe patterns:**

```python
# Moving files
move_file_with_all_companions(image_path, target_dir)

# Deleting files
send2trash(file_path)

# Reading files
data = yaml.safe_load(open(yaml_path, 'r'))

# Creating NEW files
with open('data/reports/summary.json', 'w') as f:
    json.dump(data, f)
```

**Forbidden patterns:**

```python
# ‚ùå NEVER do these (except in crop tool):
with open(existing_image.png, 'wb') as f:  # Overwriting image
    f.write(data)

PIL.Image.save(existing_file.png)  # Overwriting image

yaml.dump(data, open(existing.yaml, 'w'))  # Overwriting YAML
```

## üõ°Ô∏è When to Ask for Approval

If you're ever unsure whether a file operation is safe:

1. Stop and ask Erik
2. Explain what you want to do
3. Wait for explicit approval
4. Document the decision

**Remember:** Data loss is permanent. When in doubt, DON'T.
